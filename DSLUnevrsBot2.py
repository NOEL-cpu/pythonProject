import asyncio
import logging
import string
import random

from aiogram import Bot
from aiogram import Dispatcher
from aiogram import types
from aiogram.filters import CommandStart, Command
from aiogram.types import FSInputFile

from aiogram.types import callback_query
from googletrans import Translator

import PutToDir
from PIL import Image
import countOpenWordInfo
from Translator import translator
from RebusCouch2 import RebusImageProcessor

from aiogram.types.reply_keyboard_markup import ReplyKeyboardMarkup
from aiogram.types.keyboard_button import KeyboardButton

BOT_TOKEN = "5836801048:AAHrAtSk4LuGMQlITBn6Q3Cz91HxL_1mv94"
dp = Dispatcher()  # —à–ª–µ—Ç  —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ—Ç —Ç–µ–ª–µ–≥—Ä–∞–º –≤ –Ω–∞—à –±–æ—Ç, —Ç.–µ –∑–∞–Ω–∏–º–∞–µ—Ç—Å—è –æ–±—Ä–∞–±–æ—Ç–∫–æ–π —Å–æ–±—ã—Ç–∏–π

bot = Bot(token=BOT_TOKEN)  # –≠–∫–∑—ç–º–ø–ª—è—Ä –±–æ—Ç


@dp.message(CommandStart())
async def handle_start(message: types.Message):
    keyboard= ReplyKeyboardMarkup(keyboard=[[KeyboardButton(text="/–¢—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞",)]])
    keyboard= ReplyKeyboardMarkup(keyboard=[[KeyboardButton(text="/–ø–æ–¥—Å–∫–∞–∑–∫–∞",)]])
    await message.answer(text=f"Hello, {message.from_user.full_name}!",reply_markup=keyboard)


@dp.message(Command("help"))
async def handle_help(message: types.Message):
    text = "I'm and echo bot.\nSend me any message!"
    await message.answer(text=text)

@dp.message()
async def echo_message(message: types.Message):  # —ç—Ç–∞ —Ñ—É–Ω–∫—Ü–∏—è –≤—ã–∑–≤—ã–≤–∞–µ—Ç—Å—è  –∫–∞–∂–¥—ã–π —Ä–∞–∑ –∫–æ–≥–¥–∞ –≤ —Ç–≥ —á—Ç–æ —Ç–æ –ø—Ä–æ–∏—Å–∫—Ö–æ–¥–∏—Ç

    await message.answer(
        text="I am start",)
    try:
        text11 = message.text
#–±–ª–æ–∫ –ø–µ—Ä–µ–≤–æ–¥–∞
        if (text11[0] =="/" ):
            if(text11 == '/–¢—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞'):
                path = 'C:\\Users\\AdminX\\PycharmProjects\\pythonProject\\folder'
                result_image_path = "D:/7 Photo/DDs-bot/result.jpg"
                rebus_processor = RebusImageProcessor(path, result_image_path)
                user_query= text11
                edited_image_path = rebus_processor.process_hint(user_query)
                #1----------------
                print("123213213213!!!")
                if edited_image_path:
                    print(f"–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–æ –ø–æ –ø—É—Ç–∏: {edited_image_path}")
                    Image.open(edited_image_path).show()

                    # –í—Ç–æ—Ä–æ–π —à–∞–≥: –û–±—Ä–∞–±–æ—Ç–∫–∞ —Å–ª–µ–¥—É—é—â–∏—Ö –∑–∞–ø—Ä–æ—Å–æ–≤ –Ω–∞ –ø–æ–¥—Å–∫–∞–∑–∫–∏
                while True:
                     await message.answer( text="–í–í–µ–¥–∏—Ç–µ –∫–æ–º–∞–Ω–¥—É –ø–æ—Å–∫–∞–∑–∫–∞ –∏–ª–∏ –∫–æ–Ω–µ—Ü")
                     user_query = input("–í–≤–µ–¥–∏—Ç–µ –∫–æ–º–∞–Ω–¥—É ('–ø–æ–¥—Å–∫–∞–∑–∫–∞' –∏–ª–∏ '–∫–æ–Ω–µ—Ü'): ")
                     if user_query == "–∫–æ–Ω–µ—Ü":
                        break

                     edited_image_path = rebus_processor.process_hint(user_query)

                     if edited_image_path:
                        print(f"–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–æ –ø–æ –ø—É—Ç–∏: {edited_image_path}")
                        Image.open(edited_image_path).show()
                     else:
                        print("–û—à–∏–±–∫–∞ –≤ –æ–±—Ä–∞–±–æ—Ç–∫–µ –∑–∞–ø—Ä–æ—Å–∞.")

                #1----end
        translator = Translator()
        translator_word = translator.translate(text11, src='en', dest='ru').text
        await message.answer(translator_word)
        print(text11, translator_word)
#–±–ª–æ–∫ –ø–µ—Ä–µ–≤–æ–¥–∞ end
#67 –†–∞—Å–∫–ª–∞–¥–∫–∞ —Å–ª–æ–≤–∞ –≤ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é –∏ –æ—Ç–≤–µ—Ç –µ—Å—Ç—å –ª–∏ –∫–∞—Ä—Ç–∏–Ω–∫–∞ –¥–ª—è —Å–ª–æ–≤–∞.
        pathOfpictureForSendUser='NOTPicture'
        InfoTxt=0
        pathOfpictureForSendUser, InfoTxt =PutToDir.alfabet(text11)
        print('!1111!',pathOfpictureForSendUser)

        if(pathOfpictureForSendUser != 'NOTPicture'):
            #33–ë–ª–æ–∫ –±–ª–æ–∫ –æ—Ç—Å—ã–ª–∫–∏ –∫–∞—Ä—Ç–∏–Ω–∫–∏
            photo22 = FSInputFile(pathOfpictureForSendUser)
            await bot.send_photo(chat_id=message.chat.id, photo=photo22)

        await message.reply(text="–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞–ø—Ä–æ—Å–æ–≤ = " + str(InfoTxt))
#end67

    except ValueError as exc:
        print('–ò—Å–∫–ª  Value erorr1 (–ø–æ—Ç–æ–º—É —á—Ç–æ –Ω–µ —Ç–µ–∫—Å—Ç')
      #  print(repr(exc.errors()[0]['type']))

    except TypeError:
        print('–æ—Ç—Ä–∞–±–æ—Ç–∞–ª exeption 70 str')
        await message.reply(text="Something new üôÇ")
        print("3")

    try:
        #65 –ø–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –∏–º–µ–Ω–∏ –∫–∞—Ä—Ç–∏–Ω–∫–∏
        # –ë–∞–∑–æ–≤—ã–π URL
        base_url = "C://Users//AdminX//PycharmProjects//pythonProject//folder//bankOfPictures//"
        #D://1.2PythonTelegBot Dss//
        # –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —Å–ª—É—á–∞–π–Ω–æ–π —Å—Ç—Ä–æ–∫–∏
        length = 8  # –î–ª–∏–Ω–∞ —Å–ª—É—á–∞–π–Ω–æ–π —Å—Ç—Ä–æ–∫–∏
        letters_and_digits = string.ascii_letters + string.digits
        random_string = ''.join(random.choice(letters_and_digits) for i in range(length))
        # –§–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ –∏–º–µ–Ω–∏ —Ñ–∞–π–ª–∞
        random_filename = random_string + ".jpg"
        # –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –Ω–æ–≤–æ–≥–æ URL
        new_url = base_url + random_filename
        # –í—ã–≤–æ–¥ –Ω–æ–≤–æ–≥–æ URL
        print(new_url)
        #65 end

        #66 –±–ª–æ–∫ –∑–∞–≥—Ä—É–∑–∫–∏ –∫–∞—Ä—Ç–∏–Ω–∫–∏
        await bot.download(message.photo[-1], destination=new_url)
         #   print (type(message.photo))
        print("–æ—Ç–ø–∞–≤–∫–∞ —Ñ–æ—Ç–æ —É—Å–ø–µ—à–Ω–æ")
        #66
    except ValueError as exc2:
        print('–ò—Å–∫–ª  Value erorr2 (–ø–æ—Ç–æ–º—É —á—Ç–æ –Ω–µ –∫–∞—Ä—Ç–∏–Ω–∫–∞')



async def main():
    logging.basicConfig(level=logging.DEBUG)
    print("0")
    await dp.start_polling(bot)  # polling - —ç—Ç–æ –æ–ø—Ä–æ—Å  #?dp. —ç—Ç–æ –¥–∏—Å–ø–∞—á–µ—Ä –±—ã–ª –æ–ø–∏—Å–∞–Ω –≤–Ω–∞—á–∞–ª–µ

    print("1")


if __name__ == "__main__":
    asyncio.run(main())
    print("4")
